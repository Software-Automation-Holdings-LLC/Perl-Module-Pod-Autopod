# VERSION: fb6f9ed
# THIS FILE IS AUTOGENERATED - DO NOT EDIT
# Source: https://github.com/Software-Automation-Holdings-LLC/developer-common/blob/6f4fcf223e811ea204c26b432acaaa6c2111da1d/github-workflow-templates/copilot-review-cursor.yml

name: Copilot Review for Cursor PRs

on:
  # Trigger when Cursor opens or updates a PR
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]

  # Trigger when Copilot submits a review
  pull_request_review:
    types: [submitted]

  # NOTE: check_suite trigger removed - it fired for ALL check completions (main branch,
  # dependabot, etc.) causing concurrency group chaos. The reusable workflow has a retry
  # loop that polls for check completion, and the schedule catches anything missed.

  # Schedule to catch any missed PRs or continue loops
  schedule:
    - cron: "30 */2 * * *" # Every 2 hours

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to process"
        required: true
        type: string

# Restrict default permissions - expanded at job level
permissions: {}

# Only allow one copilot review run at a time per repo to avoid rate limits
concurrency:
  group: copilot-review-${{ github.repository }}
  cancel-in-progress: false # Don't cancel in-progress reviews, just queue

jobs:
  copilot-review:
    # Run for Cursor PRs (branch prefix), or on schedule/manual trigger
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && startsWith(github.event.pull_request.head.ref, 'cursor/')) ||
      (github.event_name == 'pull_request_review' && startsWith(github.event.pull_request.head.ref, 'cursor/'))
    permissions:
      contents: read
      pull-requests: write
      statuses: write
      security-events: read
      checks: read
    uses: Software-Automation-Holdings-LLC/developer-common/.github/workflows/copilot-review-cursor.yml@6f4fcf223e811ea204c26b432acaaa6c2111da1d
    with:
      # For pull_request/pull_request_review: use PR number; for check_run: use 0 (workflow will scan all); for workflow_dispatch: use input
      pr_number: ${{ github.event.inputs.pr_number || (github.event.pull_request.number && format('{0}', github.event.pull_request.number)) || '0' }}
    secrets:
      DEV_BOT_APP_ID: ${{ secrets.DEV_BOT_APP_ID }}
      DEV_BOT_PRIVATE_KEY: ${{ secrets.DEV_BOT_PRIVATE_KEY }}
      LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
      ZB_PAT: ${{ secrets.ZB_PAT }}
