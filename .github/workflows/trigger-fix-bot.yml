# VERSION: 2b136aa
# THIS FILE IS AUTOGENERATED - DO NOT EDIT
# Source: https://github.com/Software-Automation-Holdings-LLC/developer-common/blob/f5d26e0eb34a6ad25a1531c70c088872505f5820/github-workflow-templates/trigger-fix-bot.yml

name: Trigger Fix Bot

# Triggers fix bot when auto-fixing label is added
# Bot will read inline review comments and apply fixes

on:
  pull_request:
    types: [labeled]

# Restrict default permissions - expanded at job level
permissions: {}

jobs:
  trigger-fix-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      pull-requests: write
      contents: read
    # Only run when auto-fixing label is added
    if: |
      github.event.action == 'labeled' &&
      github.event.label.name == 'auto-fixing'
    steps:
      - name: Generate Bot Token
        id: bot-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.DEV_BOT_APP_ID }}
          private-key: ${{ secrets.DEV_BOT_PRIVATE_KEY }}
          owner: Software-Automation-Holdings-LLC

      - name: Checkout developer-common
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          repository: Software-Automation-Holdings-LLC/developer-common
          token: ${{ steps.bot-token.outputs.token }}
          path: developer-common

      - name: Post fix instructions to bot
        env:
          GH_TOKEN: ${{ steps.bot-token.outputs.token }}
          COMMENT_TOKEN: ${{ secrets.ZB_PAT }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          # Get PR details
          PR_DATA=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json headRefName)
          BRANCH_NAME=$(echo "$PR_DATA" | jq -r '.headRefName')

          # Dynamically assign fix bot based on branch name
          # If branch starts with cursor/, Cursor fixes
          # Otherwise, Copilot fixes
          if [[ "$BRANCH_NAME" == cursor/* ]]; then
            FIX_BOT_MENTION="@cursor"
            echo "üìù Cursor branch detected ‚Üí Cursor applies fixes"
          else
            FIX_BOT_MENTION="@copilot"
            echo "üìù Non-Cursor branch ‚Üí Copilot applies fixes"
          fi

          # Count existing auto-fix commits
          FIX_COUNT=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json commits \
            --jq '[.commits[].messageHeadline | select(test("auto-fix|style:|fix:.*automated"))] | length')

          # Check iteration limit
          if [ "$FIX_COUNT" -ge 3 ]; then
            echo "‚ö†Ô∏è Fix iteration limit reached ($FIX_COUNT/3)"

            # Add help wanted label
            gh pr edit "$PR_NUMBER" --repo "${{ github.repository }}" --add-label "help wanted"
            gh pr edit "$PR_NUMBER" --repo "${{ github.repository }}" --remove-label "auto-fixing"

            # Comment on PR
            printf -v LIMIT_MSG '%s\n\n%s\n\n%s' \
              "‚ö†Ô∏è **Iteration limit reached**" \
              "This PR has gone through $FIX_COUNT automated fix cycles. To prevent infinite loops, manual review is now required." \
              "Please review the inline comments and address remaining issues manually."
            gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body "$LIMIT_MSG"

            exit 0
          fi

          # Read fix bot instructions template from developer-common
          INSTRUCTIONS=$(cat developer-common/.github/fix-bot-instructions.md)

          # Replace placeholders
          INSTRUCTIONS="${INSTRUCTIONS//\{PR_NUMBER\}/$PR_NUMBER}"
          INSTRUCTIONS="${INSTRUCTIONS//\{REPO\}/${{ github.repository }}}"
          INSTRUCTIONS="${INSTRUCTIONS//\{BRANCH_NAME\}/$BRANCH_NAME}"
          INSTRUCTIONS="${INSTRUCTIONS//\{HEAD_SHA\}/$HEAD_SHA}"
          INSTRUCTIONS="${INSTRUCTIONS//\{FIX_COUNT\}/$FIX_COUNT}"
          INSTRUCTIONS="${INSTRUCTIONS//\{FIX_BOT_MENTION\}/$FIX_BOT_MENTION}"

          # Post to PR with @mention for fix bot
          printf -v COMMENT_BODY '%s\n\n%s\n\n---\n_Commit: `%s` | Fix iteration: %d/3_' \
            "üîß **$FIX_BOT_MENTION Fix Request**" \
            "$INSTRUCTIONS" \
            "${HEAD_SHA:0:7}" \
            "$FIX_COUNT"
          # Use ZB_PAT for @cursor comments so Cursor detects them (filters bot comments)
          GH_TOKEN="${COMMENT_TOKEN:-$GH_TOKEN}" gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body "$COMMENT_BODY"

          echo "‚úÖ Posted fix instructions to PR #$PR_NUMBER"
