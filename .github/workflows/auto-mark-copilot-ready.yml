# VERSION: c6f2778
# THIS FILE IS AUTOGENERATED - DO NOT EDIT
# Source: https://github.com/Software-Automation-Holdings-LLC/developer-common/blob/f5d26e0eb34a6ad25a1531c70c088872505f5820/github-workflow-templates/auto-mark-copilot-ready.yml

name: Auto trigger automated review for AI PRs

# Waits for all CI workflows to complete on AI agent PRs
# Then triggers automated review by adding ready-for-automated-review label
# Supports: GitHub Copilot, Cursor Agent (via label), and other AI bots

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

# Restrict default permissions - expanded at job level
permissions: {}

jobs:
  trigger-automated-review:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      actions: read
      pull-requests: write
      contents: read
    # Only run for draft PRs created by AI bots OR with agent-created label
    # Skip if already has ready-for-automated-review or help wanted labels
    if: >
      github.event.pull_request.draft == true &&
      (github.event.pull_request.user.login == 'github-copilot[bot]' ||
       github.event.pull_request.user.login == 'app/copilot-swe-agent' ||
       github.event.pull_request.user.login == 'Copilot' ||
       startsWith(github.event.pull_request.head.ref, 'cursor/') ||
       contains(github.event.pull_request.labels.*.name, 'agent-created')) &&
      !contains(github.event.pull_request.labels.*.name, 'ready-for-automated-review') &&
      !contains(github.event.pull_request.labels.*.name, 'help wanted')
    steps:
      - name: Generate Bot Token
        id: bot-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.DEV_BOT_APP_ID }}
          private-key: ${{ secrets.DEV_BOT_PRIVATE_KEY }}
          owner: Software-Automation-Holdings-LLC

      - name: Ensure labels exist
        env:
          GH_TOKEN: ${{ steps.bot-token.outputs.token }}
        run: |
          REPO="${{ github.repository }}"

          # Function to create label if it doesn't exist
          ensure_label() {
            local name=$1
            local color=$2
            local description=$3

            if gh label list --repo "$REPO" --json name --jq '.[].name' | grep -q "^${name}$"; then
              echo "✓ Label '${name}' exists"
            else
              echo "Creating label '${name}'..."
              gh label create "$name" --repo "$REPO" --color "$color" --description "$description"
            fi
          }

          # Create required labels
          ensure_label "ready-for-automated-review" "0366d6" "Awaiting automated bot review"
          ensure_label "agent-created" "0E8A16" "PR created by AI agent"

      - name: Wait for all workflows to complete
        uses: int128/wait-for-workflows-action@6f56a701a797895c1196d4e36554124637c639dd # v1.55.0
        with:
          initial-delay-seconds: 30
          fail-fast: false
          token: ${{ steps.bot-token.outputs.token }}

      - name: Trigger automated review
        env:
          GH_TOKEN: ${{ steps.bot-token.outputs.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "All CI workflows completed - triggering automated review"

          # Add ready-for-automated-review label (this triggers automated-review.yml)
          gh pr edit "$PR_NUMBER" --repo "${{ github.repository }}" --add-label "ready-for-automated-review"

          # Add comment to explain what's happening
          printf -v COMMENT_BODY '%s\n\n%s\n%s\n%s\n%s\n\n%s' \
            "✅ **All CI checks completed**" \
            "This PR will now undergo automated review. The review bot will:" \
            "- Check code quality and security" \
            "- Verify web deployment (if applicable)" \
            "- Apply fixes or request human assistance" \
            "Watch for the review bot's comment with detailed instructions."
          gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body "$COMMENT_BODY"
