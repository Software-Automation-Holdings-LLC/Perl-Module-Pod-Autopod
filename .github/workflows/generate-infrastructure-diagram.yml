# VERSION: 7a19cdf
# THIS FILE IS AUTOGENERATED - DO NOT EDIT
# Source: https://github.com/Software-Automation-Holdings-LLC/developer-common/blob/8d1fc342aa011694119f8ed188fe04e1b4790d56/github-workflow-templates/generate-infrastructure-diagram.yml

# Infrastructure Diagram Generator
#
# This workflow generates infrastructure diagrams from Terraform files using AI.
# It can be triggered manually or automatically on PR changes.
#
# Setup required:
# 1. Add ERASER_API_KEY secret to your repository (get from eraser.io)
# 2. Optionally add OPENAI_API_KEY if you want to use OpenAI instead of GitHub Models
# 3. DEV_BOT_APP_ID and DEV_BOT_PRIVATE_KEY for cross-repo access
# 4. MODELS_PAT for GitHub Models API access
#
# Usage:
#   Manual (single): Actions > Generate Infrastructure Diagram > select directory
#   Manual (all): Actions > Generate Infrastructure Diagram > check "Scan all"
#   Auto: Diagrams regenerate automatically when .tf files change in a PR

name: Generate Infrastructure Diagram

on:
  # Manual trigger with inputs
  workflow_dispatch:
    inputs:
      directory:
        description: "Directory containing Terraform files (ignored if scan_all)"
        type: string
        default: "."
      scan_all:
        description: "Scan and generate for ALL Terraform directories"
        type: boolean
        default: false
      module_name:
        description: "Name for the diagram (optional, ignored if scan_all)"
        type: string
        required: false
      llm_provider:
        description: "LLM provider"
        type: choice
        options:
          - github
          - openai
        default: "github"

  # Auto-regenerate when Terraform files change in a PR
  pull_request:
    types: [opened, synchronize]
    paths:
      - "**/*.tf"
      - "!.terraform/**"

# Restrict default permissions - expanded at job level
permissions: {}

jobs:
  # Auto-regenerate diagrams when Terraform files change in a PR
  auto-regenerate:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      models: read
    steps:
      - name: Generate Bot Token
        id: bot-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.DEV_BOT_APP_ID }}
          private-key: ${{ secrets.DEV_BOT_PRIVATE_KEY }}
          owner: Software-Automation-Holdings-LLC

      - name: Checkout PR branch
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ steps.bot-token.outputs.token }}

      - name: Checkout developer-common scripts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          repository: Software-Automation-Holdings-LLC/developer-common
          path: .developer-common
          sparse-checkout: scripts
          token: ${{ steps.bot-token.outputs.token }}

      - name: Check if should skip
        id: should-skip
        run: |
          # Skip if last commit was from a bot (prevents infinite loops)
          LAST_AUTHOR=$(git log -1 --format='%an')
          echo "Last commit author: $LAST_AUTHOR"

          if [[ "$LAST_AUTHOR" == *"[bot]"* ]] || [[ "$LAST_AUTHOR" == "github-actions"* ]] || [[ "$LAST_AUTHOR" == "sah-dev-bot"* ]]; then
            echo "‚è≠Ô∏è Skipping: last commit was from a bot"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Find changed Terraform directories
        id: find-changed
        if: steps.should-skip.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get list of changed .tf files in this PR
          CHANGED_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files -q '.files[].path | select(endswith(".tf"))' | grep -v "^\.terraform/" || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No .tf files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed .tf files:"
          echo "$CHANGED_FILES"

          # Extract unique directories
          DIRS=$(echo "$CHANGED_FILES" | xargs -n1 dirname 2>/dev/null | sort -u | grep -v "^\.$" || echo ".")

          # If only root directory, use "."
          if [ -z "$DIRS" ]; then
            DIRS="."
          fi

          echo ""
          echo "Directories to regenerate:"
          echo "$DIRS"

          # Count directories
          COUNT=$(echo "$DIRS" | wc -l | tr -d ' ')
          echo "dir_count=$COUNT" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Save to file for iteration
          echo "$DIRS" > /tmp/changed_dirs.txt

      - name: Setup Python
        if: steps.should-skip.outputs.skip != 'true' && steps.find-changed.outputs.has_changes == 'true'
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.should-skip.outputs.skip != 'true' && steps.find-changed.outputs.has_changes == 'true'
        run: |
          pip install openai requests pillow
          sudo apt-get update && sudo apt-get install -y pngquant || true

      - name: Regenerate diagrams for changed directories
        if: steps.should-skip.outputs.skip != 'true' && steps.find-changed.outputs.has_changes == 'true'
        env:
          MODELS_PAT: ${{ secrets.MODELS_PAT }}
          ERASER_API_KEY: ${{ secrets.ERASER_API_KEY }}
        run: |
          FAILED=0
          SUCCEEDED=0

          while read -r DIR; do
            # Skip empty lines
            [ -z "$DIR" ] && continue

            echo ""
            echo "============================================"
            echo "Regenerating: $DIR"
            echo "============================================"

            # Check if directory has .tf files
            if ! ls "$DIR"/*.tf >/dev/null 2>&1; then
              echo "‚ö†Ô∏è  No .tf files in $DIR, skipping"
              continue
            fi

            # Generate DSL
            if python .developer-common/scripts/generate-diagram-dsl.py \
                "$DIR" \
                --provider github; then

              # Render PNG
              if python .developer-common/scripts/render-diagram.py \
                  "$DIR" \
                  --api-key-from-env ERASER_API_KEY; then
                echo "‚úÖ Success: $DIR"
                SUCCEEDED=$((SUCCEEDED + 1))
              else
                echo "‚ö†Ô∏è  Render failed: $DIR"
                FAILED=$((FAILED + 1))
              fi
            else
              echo "‚ö†Ô∏è  DSL generation failed: $DIR"
              FAILED=$((FAILED + 1))
            fi
          done < /tmp/changed_dirs.txt

          echo ""
          echo "============================================"
          echo "Summary: $SUCCEEDED succeeded, $FAILED failed"
          echo "============================================"

      - name: Commit updated diagrams
        if: steps.should-skip.outputs.skip != 'true' && steps.find-changed.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ steps.bot-token.outputs.token }}
        run: |
          # Add only diagram files
          git add "**/INFRASTRUCTURE.md" "**/infrastructure.png" 2>/dev/null || true

          if git diff --staged --quiet; then
            echo "No diagram changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          CHANGED_COUNT=$(git diff --staged --name-only | wc -l | tr -d ' ')
          git commit -m "docs: auto-update infrastructure diagrams

          Updated $CHANGED_COUNT diagram file(s) based on Terraform changes.

          [skip ci]"

          git push

          echo "‚úÖ Committed diagram updates to PR branch"

      - name: Summary
        if: steps.should-skip.outputs.skip != 'true' && steps.find-changed.outputs.has_changes == 'true'
        env:
          DIR_COUNT: ${{ steps.find-changed.outputs.dir_count }}
        run: |
          echo "## üìä Auto-regenerated Infrastructure Diagrams" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Terraform changes detected in **$DIR_COUNT** director(ies)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Diagrams have been automatically regenerated and committed to this PR." >> $GITHUB_STEP_SUMMARY

  # Generate diagram via manual trigger (single directory)
  generate-manual:
    if: github.event_name == 'workflow_dispatch' && inputs.scan_all == false
    permissions:
      contents: write
      pull-requests: write
      models: read
    uses: >-
      Software-Automation-Holdings-LLC/developer-common/.github/workflows/generate-infrastructure-diagram.yml@main
    with:
      directory: ${{ inputs.directory }}
      module_name: ${{ inputs.module_name }}
      llm_provider: ${{ inputs.llm_provider }}
      create_pr: true
    secrets:
      MODELS_PAT: ${{ secrets.MODELS_PAT }}
      ERASER_API_KEY: ${{ secrets.ERASER_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DEV_BOT_APP_ID: ${{ secrets.DEV_BOT_APP_ID }}
      DEV_BOT_PRIVATE_KEY: ${{ secrets.DEV_BOT_PRIVATE_KEY }}

  # Generate diagrams for ALL Terraform directories
  generate-all:
    if: github.event_name == 'workflow_dispatch' && inputs.scan_all == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      models: read
    steps:
      - name: Generate Bot Token
        id: bot-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.DEV_BOT_APP_ID }}
          private-key: ${{ secrets.DEV_BOT_PRIVATE_KEY }}
          owner: Software-Automation-Holdings-LLC

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          token: ${{ steps.bot-token.outputs.token }}

      - name: Checkout developer-common scripts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          repository: Software-Automation-Holdings-LLC/developer-common
          path: .developer-common
          sparse-checkout: scripts
          token: ${{ steps.bot-token.outputs.token }}

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install openai requests pillow
          sudo apt-get update && sudo apt-get install -y pngquant || true

      - name: Find all Terraform directories
        id: find-dirs
        run: |
          # Find all directories containing .tf files (excluding .terraform)
          DIRS=$(find . -name "*.tf" -not -path "*/.terraform/*" -not -path "*/.developer-common/*" -exec dirname {} \; \
            | sort -u \
            | sed 's|^\./||' \
            | grep -v "^\.developer-common")

          if [ -z "$DIRS" ]; then
            echo "‚ùå No Terraform directories found"
            exit 1
          fi

          echo "Found Terraform directories:"
          echo "$DIRS"

          # Count directories
          COUNT=$(echo "$DIRS" | wc -l)
          echo "tf_dir_count=$COUNT" >> $GITHUB_OUTPUT

          # Save to file for iteration
          echo "$DIRS" > /tmp/tf_dirs.txt

      - name: Generate diagrams for all directories
        env:
          MODELS_PAT: ${{ secrets.MODELS_PAT }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ERASER_API_KEY: ${{ secrets.ERASER_API_KEY }}
          LLM_PROVIDER: ${{ inputs.llm_provider || 'github' }}
        run: |
          FAILED=0
          SUCCEEDED=0

          while read -r DIR; do
            echo ""
            echo "============================================"
            echo "Processing: $DIR"
            echo "============================================"

            # Generate DSL
            if python .developer-common/scripts/generate-diagram-dsl.py \
                "$DIR" \
                --provider "$LLM_PROVIDER"; then

              # Render PNG
              if python .developer-common/scripts/render-diagram.py \
                  "$DIR" \
                  --api-key-from-env ERASER_API_KEY; then
                echo "‚úÖ Success: $DIR"
                SUCCEEDED=$((SUCCEEDED + 1))
              else
                echo "‚ö†Ô∏è  Render failed: $DIR"
                FAILED=$((FAILED + 1))
              fi
            else
              echo "‚ö†Ô∏è  DSL generation failed: $DIR"
              FAILED=$((FAILED + 1))
            fi
          done < /tmp/tf_dirs.txt

          echo ""
          echo "============================================"
          echo "Summary: $SUCCEEDED succeeded, $FAILED failed"
          echo "============================================"

          # Fail if all failed
          if [ "$SUCCEEDED" -eq 0 ]; then
            echo "‚ùå All diagram generations failed"
            exit 1
          fi

      - name: Check for changes
        id: changes
        run: |
          # Add only INFRASTRUCTURE.md and infrastructure.png files, exclude .developer-common
          git add "**/INFRASTRUCTURE.md" "**/infrastructure.png" 2>/dev/null || true
          if git diff --staged --quiet; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected:"
            git diff --staged --name-only
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Count changed files
            CHANGED=$(git diff --staged --name-only | wc -l)
            echo "changed_count=$CHANGED" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ steps.bot-token.outputs.token }}
          TF_DIR_COUNT: ${{ steps.find-dirs.outputs.tf_dir_count }}
          CHANGED_COUNT: ${{ steps.changes.outputs.changed_count }}
          LLM_PROVIDER: ${{ inputs.llm_provider || 'github' }}
          TRIGGER: ${{ github.event_name }}
          BRANCH_NAME: update-all-infra-diagrams-${{ github.run_id }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          git commit -m "docs: update infrastructure diagrams for all modules"
          git push -u origin "$BRANCH_NAME"

          gh pr create \
            --base "main" \
            --head "$BRANCH_NAME" \
            --title "üìä Update all infrastructure diagrams" \
            --body "This PR updates infrastructure diagrams for **all Terraform modules** in the repository.

          ## Summary
          - Terraform directories scanned: $TF_DIR_COUNT
          - Files changed: $CHANGED_COUNT

          ## Generated by
          - LLM Provider: \`$LLM_PROVIDER\`
          - Trigger: $TRIGGER

          ---

          ‚ö†Ô∏è **Please review each diagram for accuracy before merging.**

          The diagrams were auto-generated and may need manual adjustments."

      - name: Summary
        env:
          TF_DIR_COUNT: ${{ steps.find-dirs.outputs.tf_dir_count }}
          HAS_CHANGES: ${{ steps.changes.outputs.has_changes }}
        run: |
          echo "## üìä Infrastructure Diagram Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Directories Processed" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform directories: $TF_DIR_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$HAS_CHANGES" == "true" ]; then
            echo "### Result" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ A pull request has been created with updated diagrams." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Result" >> $GITHUB_STEP_SUMMARY
            echo "‚ÑπÔ∏è No changes needed - all diagrams are up to date." >> $GITHUB_STEP_SUMMARY
          fi
