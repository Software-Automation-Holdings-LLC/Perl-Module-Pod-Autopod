# VERSION: 3b72b17
# THIS FILE IS AUTOGENERATED - DO NOT EDIT
# Source: https://github.com/Software-Automation-Holdings-LLC/developer-common/blob/b7889e056e06316664b15f27fe9c6577cb3fba77/github-workflow-templates/copilot-review-codegen.yml

name: Copilot Review for Codegen PRs

on:
  # Trigger when codegen opens or updates a PR
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]

  # Trigger when Copilot submits a review
  pull_request_review:
    types: [submitted]

  # Trigger when CodeQL/Analyze checks complete
  check_run:
    types: [completed]

  # Schedule to catch any missed PRs or continue loops
  schedule:
    - cron: "30 */2 * * *" # Every 2 hours

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to process"
        required: true
        type: string

# Restrict default permissions - expanded at job level
permissions: {}

# Only allow one copilot review run at a time per repo to avoid rate limits
concurrency:
  group: copilot-review-${{ github.repository }}
  cancel-in-progress: false # Don't cancel in-progress reviews, just queue

jobs:
  copilot-review:
    # Run for codegen PRs, or on schedule/manual trigger, or when CodeQL check completes
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.user.login == 'codegen-sh[bot]') ||
      (github.event_name == 'pull_request_review' && github.event.pull_request.user.login == 'codegen-sh[bot]') ||
      (github.event_name == 'check_run' && (github.event.check_run.name == 'CodeQL' || startsWith(github.event.check_run.name, 'Analyze')))
    permissions:
      contents: read
      pull-requests: write
      statuses: write
      security-events: read
      checks: read
    uses: Software-Automation-Holdings-LLC/developer-common/.github/workflows/copilot-review-codegen.yml@b7889e056e06316664b15f27fe9c6577cb3fba77
    with:
      # For pull_request/pull_request_review: use PR number; for check_run: use 0 (workflow will scan all); for workflow_dispatch: use input
      pr_number: ${{ github.event.inputs.pr_number || (github.event.pull_request.number && format('{0}', github.event.pull_request.number)) || '0' }}
    secrets:
      DEV_BOT_APP_ID: ${{ secrets.DEV_BOT_APP_ID }}
      DEV_BOT_PRIVATE_KEY: ${{ secrets.DEV_BOT_PRIVATE_KEY }}
      LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
